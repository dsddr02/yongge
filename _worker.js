import{connect}from"cloudflare:sockets";let fakeUserID,fakeHostName,userID="",proxyIP="",sub="",subConverter="SUBAPI.fxxk.dedyn.io",subConfig="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiMode.ini",subProtocol="https",subEmoji="true",socks5Address="",parsedSocks5Address={},enableSocks=!1,noTLS="false";const expire=4102329600;let proxyIPs,socks5s,BotToken,ChatID,userIDLow,动态UUID,go2Socks5s=["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org"],addresses=[],addressesapi=[],addressesnotls=[],addressesnotlsapi=[],addressescsv=[],DLS=8,remarkIndex=1,FileName=atob("ZWRnZXR1bm5lbA=="),proxyhosts=[],proxyhostsURL="",RproxyIP="false",httpsPorts=["2053","2083","2087","2096","8443"],有效时间=7,更新时间=3,userIDTime="",proxyIPPool=[],path="/?ed=2560",link=[],banHosts=[atob("c3BlZWQuY2xvdWRmbGFyZS5jb20=")];export default{async fetch(t,e,n){try{const n=t.headers.get("User-Agent")||"null",s=n.toLowerCase();if(userID=e.UUID||e.uuid||e.PASSWORD||e.pswd||userID,e.KEY||e.TOKEN||userID&&!isValidUUID(userID)){动态UUID=e.KEY||e.TOKEN||userID,有效时间=Number(e.TIME)||有效时间,更新时间=Number(e.UPTIME)||更新时间;const t=await 生成动态UUID(动态UUID);userID=t[0],userIDLow=t[1]}if(!userID)return new Response("请设置你的UUID变量，或尝试重试部署，检查变量是否生效？",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8"}});const o=new Date;o.setHours(0,0,0,0);const r=Math.ceil(o.getTime()/1e3),a=await 双重哈希(`${userID}${r}`);if(fakeUserID=[a.slice(0,8),a.slice(8,12),a.slice(12,16),a.slice(16,20),a.slice(20)].join("-"),fakeHostName=`${a.slice(6,9)}.${a.slice(13,19)}`,proxyIP=e.PROXYIP||e.proxyip||proxyIP,proxyIPs=await 整理(proxyIP),proxyIP=proxyIPs[Math.floor(Math.random()*proxyIPs.length)],socks5Address=e.SOCKS5||socks5Address,socks5s=await 整理(socks5Address),socks5Address=socks5s[Math.floor(Math.random()*socks5s.length)],socks5Address=socks5Address.split("//")[1]||socks5Address,e.GO2SOCKS5&&(go2Socks5s=await 整理(e.GO2SOCKS5)),e.CFPORTS&&(httpsPorts=await 整理(e.CFPORTS)),e.BAN&&(banHosts=await 整理(e.BAN)),socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),RproxyIP=e.RPROXYIP||"false",enableSocks=!0}catch(t){let n=t;console.log(n.toString()),RproxyIP=e.RPROXYIP||!proxyIP?"true":"false",enableSocks=!1}else RproxyIP=e.RPROXYIP||!proxyIP?"true":"false";const l=t.headers.get("Upgrade"),i=new URL(t.url);if(l&&"websocket"===l){if(socks5Address=i.searchParams.get("socks5")||socks5Address,new RegExp("/socks5=","i").test(i.pathname))socks5Address=i.pathname.split("5=")[1];else if((new RegExp("/socks://","i").test(i.pathname)||new RegExp("/socks5://","i").test(i.pathname))&&(socks5Address=i.pathname.split("://")[1].split("#")[0],socks5Address.includes("@"))){let t=socks5Address.split("@")[0];/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i.test(t)&&!t.includes(":")&&(t=atob(t)),socks5Address=`${t}@${socks5Address.split("@")[1]}`}if(socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),enableSocks=!0}catch(t){let e=t;console.log(e.toString()),enableSocks=!1}else enableSocks=!1;return i.searchParams.has("proxyip")?(proxyIP=i.searchParams.get("proxyip"),enableSocks=!1):new RegExp("/proxyip=","i").test(i.pathname)?(proxyIP=i.pathname.toLowerCase().split("/proxyip=")[1],enableSocks=!1):new RegExp("/proxyip.","i").test(i.pathname)?(proxyIP=`proxyip.${i.pathname.toLowerCase().split("/proxyip.")[1]}`,enableSocks=!1):new RegExp("/pyip=","i").test(i.pathname)&&(proxyIP=i.pathname.toLowerCase().split("/pyip=")[1],enableSocks=!1),await 维列斯OverWSHandler(t)}{e.ADD&&(addresses=await 整理(e.ADD)),e.ADDAPI&&(addressesapi=await 整理(e.ADDAPI)),e.ADDNOTLS&&(addressesnotls=await 整理(e.ADDNOTLS)),e.ADDNOTLSAPI&&(addressesnotlsapi=await 整理(e.ADDNOTLSAPI)),e.ADDCSV&&(addressescsv=await 整理(e.ADDCSV)),DLS=Number(e.DLS)||DLS,remarkIndex=Number(e.CSVREMARK)||remarkIndex,BotToken=e.TGTOKEN||BotToken,ChatID=e.TGID||ChatID,FileName=e.SUBNAME||FileName,subEmoji=e.SUBEMOJI||e.EMOJI||subEmoji,"0"==subEmoji&&(subEmoji="false"),e.LINK&&(link=await 整理(e.LINK)),sub=e.SUB||sub,subConverter=e.SUBAPI||subConverter,subConverter.includes("http://")?(subConverter=subConverter.split("//")[1],subProtocol="http"):subConverter=subConverter.split("//")[1]||subConverter,subConfig=e.SUBCONFIG||subConfig,i.searchParams.has("sub")&&""!==i.searchParams.get("sub")&&(sub=i.searchParams.get("sub")),i.searchParams.has("notls")&&(noTLS="true"),i.searchParams.has("proxyip")?(path=`/?ed=2560&proxyip=${i.searchParams.get("proxyip")}`,RproxyIP="false"):i.searchParams.has("socks5")?(path=`/?ed=2560&socks5=${i.searchParams.get("socks5")}`,RproxyIP="false"):i.searchParams.has("socks")&&(path=`/?ed=2560&socks5=${i.searchParams.get("socks")}`,RproxyIP="false");const o=i.pathname.toLowerCase();if("/"==o)return e.URL302?Response.redirect(e.URL302,302):e.URL?await 代理URL(e.URL,i):new Response(JSON.stringify(t.cf,null,4),{status:200,headers:{"content-type":"application/json"}});if(o==`/${fakeUserID}`){const n=await 生成配置信息(userID,t.headers.get("Host"),sub,"CF-Workers-SUB",RproxyIP,i,e);return new Response(`${n}`,{status:200})}if(i.pathname==`/${动态UUID}/edit`||o==`/${userID}/edit`){return await KV(t,e)}if(i.pathname==`/${动态UUID}`||o==`/${userID}`){await sendMessage(`#获取订阅 ${FileName}`,t.headers.get("CF-Connecting-IP"),`UA: ${n}</tg-spoiler>\n域名: ${i.hostname}\n<tg-spoiler>入口: ${i.pathname+i.search}</tg-spoiler>`);const o=await 生成配置信息(userID,t.headers.get("Host"),sub,n,RproxyIP,i,e),r=Date.now(),a=new Date(r);a.setHours(0,0,0,0);const l=Math.floor((r-a.getTime())/864e5*24*1099511627776/2);let c=l,d=l,p=26388279066624;return s&&s.includes("mozilla")?new Response(`<div style="font-size:13px;">${o}</div>`,{status:200,headers:{"Content-Type":"text/html;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${c}; download=${d}; total=${p}; expire=${expire}`,"Cache-Control":"no-store"}}):new Response(`${o}`,{status:200,headers:{"Content-Disposition":`attachment; filename=${FileName}; filename*=utf-8''${encodeURIComponent(FileName)}`,"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${c}; download=${d}; total=${p}; expire=${expire}`}})}return e.URL302?Response.redirect(e.URL302,302):e.URL?await 代理URL(e.URL,i):new Response("不用怀疑！你UUID就是错的！！！",{status:404})}}catch(t){return new Response(t.toString())}}};async function 维列斯OverWSHandler(t){const e=new WebSocketPair,[n,s]=Object.values(e);s.accept();let o="",r="";const log=(t,e)=>{console.log(`[${o}:${r}] ${t}`,e||"")},a=t.headers.get("sec-websocket-protocol")||"",l=makeReadableWebSocketStream(s,a,log);let i={value:null},c=!1;return l.pipeTo(new WritableStream({async write(t,e){if(c)return await handleDNSQuery(t,s,null,log);if(i.value){const e=i.value.writable.getWriter();return await e.write(t),void e.releaseLock()}const{hasError:n,message:a,addressType:l,portRemote:d=443,addressRemote:p="",rawDataIndex:u,"维列斯Version":U=new Uint8Array([0,0]),isUDP:b}=process维列斯Header(t,userID);if(o=p,r=`${d}--${Math.random()} ${b?"udp ":"tcp "} `,n)throw new Error(a);if(b){if(53!==d)throw new Error("UDP 代理仅对 DNS（53 端口）启用");c=!0}const y=new Uint8Array([U[0],0]),S=t.slice(u);if(c)return handleDNSQuery(S,s,y,log);if(banHosts.includes(p))throw new Error(`黑名单关闭 TCP 出站连接 ${p}:${d}`);log(`处理 TCP 出站连接 ${p}:${d}`),handleTCPOutBound(i,l,p,d,S,s,y,log)},close(){log("readableWebSocketStream 已关闭")},abort(t){log("readableWebSocketStream 已中止",JSON.stringify(t))}})).catch((t=>{log("readableWebSocketStream 管道错误",t)})),new Response(null,{status:101,webSocket:n})}async function handleTCPOutBound(t,e,n,s,o,r,a,l){async function connectAndWrite(n,s,r=!1){l(`connected to ${n}:${s}`);const a=r?await socks5Connect(e,n,s,l):connect({hostname:n,port:s});t.value=a;const i=a.writable.getWriter();return await i.write(o),i.releaseLock(),a}let i=!1;go2Socks5s.length>0&&enableSocks&&(i=await async function(t){return!(!go2Socks5s.includes(atob("YWxsIGlu"))&&!go2Socks5s.includes(atob("Kg==")))||go2Socks5s.some((e=>{let n=e.replace(/\*/g,".*");return new RegExp(`^${n}$`,"i").test(t)}))}(n));let c=await connectAndWrite(n,s,i);remoteSocketToWS(c,r,a,(async function(){enableSocks?c=await connectAndWrite(n,s,!0):(proxyIP&&""!=proxyIP?proxyIP.includes("]:")?(s=proxyIP.split("]:")[1]||s,proxyIP=proxyIP.split("]:")[0]||proxyIP):2===proxyIP.split(":").length&&(s=proxyIP.split(":")[1]||s,proxyIP=proxyIP.split(":")[0]||proxyIP):proxyIP=atob("UFJPWFlJUC50cDEuZnh4ay5kZWR5bi5pbw=="),proxyIP.includes(".tp")&&(s=proxyIP.split(".tp")[1].split(".")[0]||s),c=await connectAndWrite(proxyIP||n,s)),c.closed.catch((t=>{console.log("retry tcpSocket closed error",t)})).finally((()=>{safeCloseWebSocket(r)})),remoteSocketToWS(c,r,a,null,l)}),l)}function makeReadableWebSocketStream(t,e,n){let s=!1;return new ReadableStream({start(o){t.addEventListener("message",(t=>{if(s)return;const e=t.data;o.enqueue(e)})),t.addEventListener("close",(()=>{safeCloseWebSocket(t),s||o.close()})),t.addEventListener("error",(t=>{n("WebSocket 服务器发生错误"),o.error(t)}));const{earlyData:r,error:a}=base64ToArrayBuffer(e);a?o.error(a):r&&o.enqueue(r)},pull(t){},cancel(e){s||(n(`可读流被取消，原因是 ${e}`),s=!0,safeCloseWebSocket(t))}})}function process维列斯Header(t,e){if(t.byteLength<24)return{hasError:!0,message:"invalid data"};const n=new Uint8Array(t.slice(0,1));let s=!1,o=!1;if(s=function(t,e,n){const s=stringify(new Uint8Array(n.slice(1,17)));return s===t||s===e}(e,userIDLow,t),!s)return{hasError:!0,message:`invalid user ${new Uint8Array(t.slice(1,17))}`};const r=new Uint8Array(t.slice(17,18))[0],a=new Uint8Array(t.slice(18+r,18+r+1))[0];if(1===a);else{if(2!==a)return{hasError:!0,message:`command ${a} is not support, command 01-tcp,02-udp,03-mux`};o=!0}const l=18+r+1,i=t.slice(l,l+2),c=new DataView(i).getUint16(0);let d=l+2;const p=new Uint8Array(t.slice(d,d+1))[0];let u=0,U=d+1,b="";switch(p){case 1:u=4,b=new Uint8Array(t.slice(U,U+u)).join(".");break;case 2:u=new Uint8Array(t.slice(U,U+1))[0],U+=1,b=(new TextDecoder).decode(t.slice(U,U+u));break;case 3:u=16;const e=new DataView(t.slice(U,U+u)),n=[];for(let t=0;t<8;t++)n.push(e.getUint16(2*t).toString(16));b=n.join(":");break;default:return{hasError:!0,message:`invild addressType is ${p}`}}return b?{hasError:!1,addressRemote:b,addressType:p,portRemote:c,rawDataIndex:U+u,"维列斯Version":n,isUDP:o}:{hasError:!0,message:`addressValue is empty, addressType is ${p}`}}async function remoteSocketToWS(t,e,n,s,o){let r=n,a=!1;await t.readable.pipeTo(new WritableStream({start(){},async write(t,n){a=!0,e.readyState!==WS_READY_STATE_OPEN&&n.error("webSocket.readyState is not open, maybe close"),r?(e.send(await new Blob([r,t]).arrayBuffer()),r=null):e.send(t)},close(){o(`remoteConnection!.readable is close with hasIncomingData is ${a}`)},abort(t){console.error("remoteConnection!.readable abort",t)}})).catch((t=>{console.error("remoteSocketToWS has exception ",t.stack||t),safeCloseWebSocket(e)})),!1===a&&s&&(o("retry"),s())}function base64ToArrayBuffer(t){if(!t)return{earlyData:void 0,error:null};try{t=t.replace(/-/g,"+").replace(/_/g,"/");const e=atob(t);return{earlyData:Uint8Array.from(e,(t=>t.charCodeAt(0))).buffer,error:null}}catch(t){return{earlyData:void 0,error:t}}}function isValidUUID(t){return/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}const WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(t){try{t.readyState!==WS_READY_STATE_OPEN&&t.readyState!==WS_READY_STATE_CLOSING||t.close()}catch(t){console.error("safeCloseWebSocket error",t)}}const byteToHex=[];for(let t=0;t<256;++t)byteToHex.push((t+256).toString(16).slice(1));function unsafeStringify(t,e=0){return(byteToHex[t[e+0]]+byteToHex[t[e+1]]+byteToHex[t[e+2]]+byteToHex[t[e+3]]+"-"+byteToHex[t[e+4]]+byteToHex[t[e+5]]+"-"+byteToHex[t[e+6]]+byteToHex[t[e+7]]+"-"+byteToHex[t[e+8]]+byteToHex[t[e+9]]+"-"+byteToHex[t[e+10]]+byteToHex[t[e+11]]+byteToHex[t[e+12]]+byteToHex[t[e+13]]+byteToHex[t[e+14]]+byteToHex[t[e+15]]).toLowerCase()}function stringify(t,e=0){const n=unsafeStringify(t,e);if(!isValidUUID(n))throw TypeError(`生成的 UUID 不符合规范 ${n}`);return n}async function handleDNSQuery(t,e,n,s){try{const o="8.8.4.4",r=53;let a=n;const l=connect({hostname:o,port:r});s(`连接到 ${o}:${r}`);const i=l.writable.getWriter();await i.write(t),i.releaseLock(),await l.readable.pipeTo(new WritableStream({async write(t){e.readyState===WS_READY_STATE_OPEN&&(a?(e.send(await new Blob([a,t]).arrayBuffer()),a=null):e.send(t))},close(){s(`DNS 服务器(${o}) TCP 连接已关闭`)},abort(t){console.error(`DNS 服务器(${o}) TCP 连接异常中断`,t)}}))}catch(t){console.error(`handleDNSQuery 函数发生异常，错误信息: ${t.message}`)}}async function socks5Connect(t,e,n,s){const{username:o,password:r,hostname:a,port:l}=parsedSocks5Address,i=connect({hostname:a,port:l}),c=new Uint8Array([5,2,0,2]),d=i.writable.getWriter();await d.write(c),s("已发送 SOCKS5 问候消息");const p=i.readable.getReader(),u=new TextEncoder;let U,b=(await p.read()).value;if(5!==b[0])return void s(`SOCKS5 服务器版本错误: 收到 ${b[0]}，期望是 5`);if(255===b[1])return void s("服务器不接受任何认证方法");if(2===b[1]){if(s("SOCKS5 服务器需要认证"),!o||!r)return void s("请提供用户名和密码");const t=new Uint8Array([1,o.length,...u.encode(o),r.length,...u.encode(r)]);if(await d.write(t),b=(await p.read()).value,1!==b[0]||0!==b[1])return void s("SOCKS5 服务器认证失败")}switch(t){case 1:U=new Uint8Array([1,...e.split(".").map(Number)]);break;case 2:U=new Uint8Array([3,e.length,...u.encode(e)]);break;case 3:U=new Uint8Array([4,...e.split(":").flatMap((t=>[parseInt(t.slice(0,2),16),parseInt(t.slice(2),16)]))]);break;default:return void s(`无效的地址类型: ${t}`)}const y=new Uint8Array([5,1,0,...U,n>>8,255&n]);if(await d.write(y),s("已发送 SOCKS5 请求"),b=(await p.read()).value,0===b[1])return s("SOCKS5 连接已建立"),d.releaseLock(),p.releaseLock(),i;s("SOCKS5 连接建立失败")}function socks5AddressParser(t){let e,n,s,o,[r,a]=t.split("@").reverse();if(a){const t=a.split(":");if(2!==t.length)throw new Error('无效的 SOCKS 地址格式：认证部分必须是 "username:password" 的形式');[e,n]=t}const l=r.split(":");if(o=Number(l.pop()),isNaN(o))throw new Error("无效的 SOCKS 地址格式：端口号必须是数字");s=l.join(":");if(s.includes(":")&&!/^\[.*\]$/.test(s))throw new Error("无效的 SOCKS 地址格式：IPv6 地址必须用方括号括起来，如 [2001:db8::1]");return{username:e,password:n,hostname:s,port:o}}function 恢复伪装信息(t,e,n,s){return s&&(t=atob(t)),t=t.replace(new RegExp(fakeUserID,"g"),e).replace(new RegExp(fakeHostName,"g"),n),s&&(t=btoa(t)),t}async function 双重哈希(t){const e=new TextEncoder,n=await crypto.subtle.digest("MD5",e.encode(t)),s=Array.from(new Uint8Array(n)).map((t=>t.toString(16).padStart(2,"0"))).join(""),o=await crypto.subtle.digest("MD5",e.encode(s.slice(7,27)));return Array.from(new Uint8Array(o)).map((t=>t.toString(16).padStart(2,"0"))).join("").toLowerCase()}async function 代理URL(t,e){const n=await 整理(t),s=n[Math.floor(Math.random()*n.length)];let o=new URL(s);console.log(o);let r=o.protocol.slice(0,-1)||"https",a=o.hostname,l=o.pathname,i=o.search;"/"==l.charAt(l.length-1)&&(l=l.slice(0,-1)),l+=e.pathname;let c=`${r}://${a}${l}${i}`,d=await fetch(c),p=new Response(d.body,{status:d.status,statusText:d.statusText,headers:d.headers});return p.headers.set("X-New-URL",c),p}const 啥啥啥_写的这是啥啊=atob("ZG14bGMzTT0=");function 配置信息(t,e){const n=atob(啥啥啥_写的这是啥啊),s=FileName;let o=e,r=443;const a=t,l=e,i=path;let c=["tls",!0];const d=e,p="randomized";e.includes(".workers.dev")&&(o=atob("dmlzYS5jbg=="),r=80,c=["",!1]);return[`${n}://${a}@${o}:${r}?encryp${atob("dGlvbj0=")+"none"}&security=${c[0]}&sni=${d}&fp=${p}&type=ws&host=${l}&path=${encodeURIComponent(i)}#${encodeURIComponent(s)}`,`- {name: ${FileName}, server: ${o}, port: ${r}, type: ${n}, uuid: ${a}, tls: ${c[1]}, alpn: [h3], udp: false, sni: ${d}, tfo: false, skip-cert-verify: true, servername: ${l}, client-fingerprint: ${p}, network: ws, ws-opts: {path: "${i}", headers: {${l}}}}`]}let subParams=["sub","base64","b64","clash","singbox","sb"];const cmad=decodeURIComponent(atob("dGVsZWdyYW0lMjAlRTQlQkElQTQlRTYlQjUlODElRTclQkUlQTQlMjAlRTYlOEElODAlRTYlOUMlQUYlRTUlQTQlQTclRTQlQkQlQUMlN0UlRTUlOUMlQTglRTclQkElQkYlRTUlOEYlOTElRTclODklOEMhJTNDYnIlM0UKJTNDYSUyMGhyZWYlM0QlMjdodHRwcyUzQSUyRiUyRnQubWUlMkZDTUxpdXNzc3MlMjclM0VodHRwcyUzQSUyRiUyRnQubWUlMkZDTUxpdXNzc3MlM0MlMkZhJTNFJTNDYnIlM0UKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJTNDYnIlM0UKZ2l0aHViJTIwJUU5JUExJUI5JUU3JTlCJUFFJUU1JTlDJUIwJUU1JTlEJTgwJTIwU3RhciFTdGFyIVN0YXIhISElM0NiciUzRQolM0NhJTIwaHJlZiUzRCUyN2h0dHBzJTNBJTJGJTJGZ2l0aHViLmNvbSUyRmNtbGl1JTJGZWRnZXR1bm5lbCUyNyUzRWh0dHBzJTNBJTJGJTJGZ2l0aHViLmNvbSUyRmNtbGl1JTJGZWRnZXR1bm5lbCUzQyUyRmElM0UlM0NiciUzRQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0lM0NiciUzRQolMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjM="));async function 生成配置信息(t,e,n,s,o,r,a){if(n){const U=n.match(/^(?:https?:\/\/)?([^\/]+)/);U&&(n=U[1]);const b=await 整理(n);b.length>1&&(n=b[0])}else{if(a.KV){await 迁移地址列表(a);const y=await a.KV.get("ADD.txt");if(y){const S=await 整理(y),T={"接口地址":new Set,"链接地址":new Set,"优选地址":new Set};for(const M of S)M.startsWith("https://")?T.接口地址.add(M):M.includes("://")?T.链接地址.add(M):T.优选地址.add(M);addressesapi=[...T.接口地址],link=[...T.链接地址],addresses=[...T.优选地址]}}if(addresses.length+addressesapi.length+addressesnotls.length+addressesnotlsapi.length+addressescsv.length==0){let h=["103.21.244.0/23","104.16.0.0/13","104.24.0.0/14","172.64.0.0/14","103.21.244.0/23","104.16.0.0/14","104.24.0.0/15","141.101.64.0/19","172.64.0.0/14","188.114.96.0/21","190.93.240.0/21"];function generateRandomIPFromCIDR(t){const[e,n]=t.split("/"),s=e.split(".").map(Number),o=32-parseInt(n,10),r=Math.pow(2,o)-1,a=Math.floor(Math.random()*r);return s.map(((t,e)=>e<2?t:2===e?(t&255<<o-8)+(a>>8&255):(t&255<<o)+(255&a))).join(".")}addresses=addresses.concat("127.0.0.1:1234#CFnat"),e.includes(".workers.dev")?addressesnotls=addressesnotls.concat(h.map((t=>generateRandomIPFromCIDR(t)+"#CF随机节点"))):addresses=addresses.concat(h.map((t=>generateRandomIPFromCIDR(t)+"#CF随机节点")))}}const l=r.pathname==`/${动态UUID}`?动态UUID:t,i=s.toLowerCase(),c=配置信息(t,e),d=c[0],p=c[1];let u="";if(e.includes(".workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const m=await fetch(proxyhostsURL);if(!m.ok)return void console.error("获取地址时出错:",m.status,m.statusText);const C=await m.text(),g=C.split("\n").filter((t=>""!==t.trim()));proxyhosts=proxyhosts.concat(g)}catch(f){}0!=proxyhosts.length&&(u=proxyhosts[Math.floor(Math.random()*proxyhosts.length)]+"/")}if(i.includes("mozilla")&&!subParams.some((t=>r.searchParams.has(t)))){const w=socks5s.map((t=>t.includes("@")?t.split("@")[1]:t.includes("//")?t.split("//")[1]:t));let R="";go2Socks5s.length>0&&enableSocks&&(R=`${decodeURIComponent("SOCKS5%EF%BC%88%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%89%3A%20")}`,go2Socks5s.includes(atob("YWxsIGlu"))||go2Socks5s.includes(atob("Kg=="))?R+=`${decodeURIComponent("%E6%89%80%E6%9C%89%E6%B5%81%E9%87%8F")}<br>`:R+=`<br>&nbsp;&nbsp;${go2Socks5s.join("<br>&nbsp;&nbsp;")}<br>`);let N="<br>";if(n)N+=enableSocks?`CFCDN（访问方式）: Socks5<br>&nbsp;&nbsp;${w.join("<br>&nbsp;&nbsp;")}<br>${R}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP<br>&nbsp;&nbsp;${proxyIPs.join("<br>&nbsp;&nbsp;")}<br>`:"true"==o?"CFCDN（访问方式）: 自动获取ProxyIP<br>":"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！<br>",N+=`<br>SUB（优选订阅生成器）: ${n}`;else{N+=enableSocks?`CFCDN（访问方式）: Socks5<br>&nbsp;&nbsp;${w.join("<br>&nbsp;&nbsp;")}<br>${R}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP<br>&nbsp;&nbsp;${proxyIPs.join("<br>&nbsp;&nbsp;")}<br>`:"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！<br>";let k="";a.KV&&(k=` <a href='${r.pathname}/edit'>编辑优选列表</a>`),N+=`<br>您的订阅内容由 内置 addresses/ADD* 参数变量提供${k}<br>`,addresses.length>0&&(N+=`ADD（TLS优选域名&IP）: <br>&nbsp;&nbsp;${addresses.join("<br>&nbsp;&nbsp;")}<br>`),addressesnotls.length>0&&(N+=`ADDNOTLS（noTLS优选域名&IP）: <br>&nbsp;&nbsp;${addressesnotls.join("<br>&nbsp;&nbsp;")}<br>`),addressesapi.length>0&&(N+=`ADDAPI（TLS优选域名&IP 的 API）: <br>&nbsp;&nbsp;${addressesapi.join("<br>&nbsp;&nbsp;")}<br>`),addressesnotlsapi.length>0&&(N+=`ADDNOTLSAPI（noTLS优选域名&IP 的 API）: <br>&nbsp;&nbsp;${addressesnotlsapi.join("<br>&nbsp;&nbsp;")}<br>`),addressescsv.length>0&&(N+=`ADDCSV（IPTest测速csv文件 限速 ${DLS} ）: <br>&nbsp;&nbsp;${addressescsv.join("<br>&nbsp;&nbsp;")}<br>`)}动态UUID&&r.pathname!==`/${动态UUID}`?N="":N+=`<br>SUBAPI（订阅转换后端）: ${subProtocol}://${subConverter}<br>SUBCONFIG（订阅转换配置文件）: ${subConfig}`;const x=l!=t?`TOKEN: ${l}<br>UUIDNow: ${t}<br>UUIDLow: ${userIDLow}<br>${userIDTime}TIME（动态UUID有效时间）: ${有效时间} 天<br>UPTIME（动态UUID更新时间）: ${更新时间} 时（北京时间）<br><br>`:`${userIDTime}`;return`\n\t\t\t################################################################<br>\n\t\t\tSubscribe / sub 订阅地址, 点击链接自动 <strong>复制订阅链接</strong> 并 <strong>生成订阅二维码</strong> <br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t自适应订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${u}${e}/${l}?sub','qrcode_0')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${u}${e}/${l}</a><br>\n\t\t\t<div id="qrcode_0" style="margin: 10px 10px 10px 10px;"></div>\n\t\t\tBase64订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${u}${e}/${l}?b64','qrcode_1')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${u}${e}/${l}?b64</a><br>\n\t\t\t<div id="qrcode_1" style="margin: 10px 10px 10px 10px;"></div>\n\t\t\tclash订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${u}${e}/${l}?clash','qrcode_2')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${u}${e}/${l}?clash</a><br>\n\t\t\t<div id="qrcode_2" style="margin: 10px 10px 10px 10px;"></div>\n\t\t\tsingbox订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${u}${e}/${l}?sb','qrcode_3')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${u}${e}/${l}?sb</a><br>\n\t\t\t<div id="qrcode_3" style="margin: 10px 10px 10px 10px;"></div>\n\t\t\t<strong><a href="javascript:void(0);" id="noticeToggle" onclick="toggleNotice()">实用订阅技巧∨</a></strong><br>\n\t\t\t\t<div id="noticeContent" class="notice-content" style="display: none;">\n\t\t\t\t\t<strong>1.</strong> 如您使用的是 PassWall、SSR+ 等路由插件，推荐使用 <strong>Base64订阅地址</strong> 进行订阅；<br>\n\t\t\t\t\t<br>\n\t\t\t\t\t<strong>2.</strong> 快速切换 <a href='${atob("aHR0cHM6Ly9naXRodWIuY29tL2NtbGl1L1dvcmtlclZsZXNzMnN1Yg==")}'>优选订阅生成器</a> 至：sub.google.com，您可将"?sub=sub.google.com"参数添加到链接末尾，例如：<br>\n\t\t\t\t\t&nbsp;&nbsp;https://${u}${e}/${l}<strong>?sub=sub.google.com</strong><br>\n\t\t\t\t\t<br>\n\t\t\t\t\t<strong>3.</strong> 快速更换 PROXYIP 至：proxyip.fxxk.dedyn.io:443，您可将"?proxyip=proxyip.fxxk.dedyn.io:443"参数添加到链接末尾，例如：<br>\n\t\t\t\t\t&nbsp;&nbsp; https://${u}${e}/${l}<strong>?proxyip=proxyip.fxxk.dedyn.io:443</strong><br>\n\t\t\t\t\t<br>\n\t\t\t\t\t<strong>4.</strong> 快速更换 SOCKS5 至：user:password@127.0.0.1:1080，您可将"?socks5=user:password@127.0.0.1:1080"参数添加到链接末尾，例如：<br>\n\t\t\t\t\t&nbsp;&nbsp;https://${u}${e}/${l}<strong>?socks5=user:password@127.0.0.1:1080</strong><br>\n\t\t\t\t\t<br>\n\t\t\t\t\t<strong>5.</strong> 如需指定多个参数则需要使用'&'做间隔，例如：<br>\n\t\t\t\t\t&nbsp;&nbsp;https://${u}${e}/${l}?sub=sub.google.com<strong>&</strong>proxyip=proxyip.fxxk.dedyn.io<br>\n\t\t\t\t</div>\n\t\t\t<script src="https://cdn.jsdelivr.net/npm/@keeex/qrcodejs-kx@1.0.2/qrcode.min.js"><\/script>\n\t\t\t<script>\n\t\t\tfunction copyToClipboard(text, qrcode) {\n\t\t\t\tnavigator.clipboard.writeText(text).then(() => {\n\t\t\t\t\talert('已复制到剪贴板');\n\t\t\t\t}).catch(err => {\n\t\t\t\t\tconsole.error('复制失败:', err);\n\t\t\t\t});\n\t\t\t\tconst qrcodeDiv = document.getElementById(qrcode);\n\t\t\t\tqrcodeDiv.innerHTML = '';\n\t\t\t\tnew QRCode(qrcodeDiv, {\n\t\t\t\t\ttext: text,\n\t\t\t\t\twidth: 220, // 调整宽度\n\t\t\t\t\theight: 220, // 调整高度\n\t\t\t\t\tcolorDark: "#000000", // 二维码颜色\n\t\t\t\t\tcolorLight: "#ffffff", // 背景颜色\n\t\t\t\t\tcorrectLevel: QRCode.CorrectLevel.Q, // 设置纠错级别\n\t\t\t\t\tscale: 1 // 调整像素颗粒度\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tfunction toggleNotice() {\n\t\t\t\tconst noticeContent = document.getElementById('noticeContent');\n\t\t\t\tconst noticeToggle = document.getElementById('noticeToggle');\n\t\t\t\tif (noticeContent.style.display === 'none') {\n\t\t\t\t\tnoticeContent.style.display = 'block';\n\t\t\t\t\tnoticeToggle.textContent = '实用订阅技巧∧';\n\t\t\t\t} else {\n\t\t\t\t\tnoticeContent.style.display = 'none'; \n\t\t\t\t\tnoticeToggle.textContent = '实用订阅技巧∨';\n\t\t\t\t}\n\t\t\t}\n\t\t\t<\/script>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\t${FileName} 配置信息<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t${x}HOST: ${e}<br>\n\t\t\tUUID: ${t}<br>\n\t\t\tFKID: ${fakeUserID}<br>\n\t\t\tUA: ${s}<br>\n\t\t\t${N}<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\tv2ray<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('${d}','qrcode_v2ray')" style="color:blue;text-decoration:underline;cursor:pointer;">${d}</a><br>\n\t\t\t<div id="qrcode_v2ray" style="margin: 10px 10px 10px 10px;"></div>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\tclash-meta<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t${p}<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\t${cmad}\n\t\t\t`}{if("function"!=typeof fetch)return"Error: fetch is not available in this environment.";let V=[],I=[],$=[],J=[];e.includes(".workers.dev")?(noTLS="true",fakeHostName=`${fakeHostName}.workers.dev`,$=await 整理优选列表(addressesnotlsapi),J=await 整理测速结果("FALSE")):e.includes(".pages.dev")?fakeHostName=`${fakeHostName}.pages.dev`:e.includes("worker")||e.includes("notls")||"true"==noTLS?(noTLS="true",fakeHostName=`notls${fakeHostName}.net`,$=await 整理优选列表(addressesnotlsapi),J=await 整理测速结果("FALSE")):fakeHostName=`${fakeHostName}.xyz`,console.log(`虚假HOST: ${fakeHostName}`);let D=`${subProtocol}://${n}/sub?host=${fakeHostName}&uuid=${fakeUserID+atob("JmVkZ2V0dW5uZWw9Y21saXUmcHJveHlpcD0=")+o}&path=${encodeURIComponent(path)}`,Q=!0;if(!n||""==n){if(e.includes("workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const O=await fetch(proxyhostsURL);if(!O.ok)return void console.error("获取地址时出错:",O.status,O.statusText);const E=await O.text(),A=E.split("\n").filter((t=>""!==t.trim()));proxyhosts=proxyhosts.concat(A)}catch(P){console.error("获取地址时出错:",P)}proxyhosts=[...new Set(proxyhosts)]}V=await 整理优选列表(addressesapi),I=await 整理测速结果("TRUE"),D=`https://${e}/${fakeUserID+r.search}`,(e.includes("worker")||e.includes("notls")||"true"==noTLS)&&(r.search?D+="&notls":D+="?notls"),console.log(`虚假订阅: ${D}`)}i.includes("CF-Workers-SUB".toLowerCase())||(i.includes("clash")&&!i.includes("nekobox")||r.searchParams.has("clash")&&!i.includes("subconverter")?(D=`${subProtocol}://${subConverter}/sub?target=clash&url=${encodeURIComponent(D)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,Q=!1):(i.includes("sing-box")||i.includes("singbox")||(r.searchParams.has("singbox")||r.searchParams.has("sb"))&&!i.includes("subconverter"))&&(D=`${subProtocol}://${subConverter}/sub?target=singbox&url=${encodeURIComponent(D)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,Q=!1));try{let F;if(n&&""!=n||1!=Q){const v=await fetch(D,{headers:{"User-Agent":s+atob("IENGLVdvcmtlcnMtZWRnZXR1bm5lbC9jbWxpdQ==")}});F=await v.text()}else F=await 生成本地订阅(fakeHostName,fakeUserID,noTLS,V,I,$,J);return r.pathname==`/${fakeUserID}`?F:恢复伪装信息(F,t,e,Q)}catch(j){return console.error("Error fetching content:",j),`Error fetching content: ${j.message}`}}}async function 整理优选列表(t){if(!t||0===t.length)return[];let e="";const n=new AbortController,s=setTimeout((()=>{n.abort()}),2e3);try{const s=await Promise.allSettled(t.map((t=>fetch(t,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","User-Agent":atob("Q0YtV29ya2Vycy1lZGdldHVubmVsL2NtbGl1")},signal:n.signal}).then((t=>t.ok?t.text():Promise.reject())))));for(const[n,o]of s.entries())if("fulfilled"===o.status){const s=await o.value,r=s.split(/\r?\n/);let a="",l="443";if(r[0].split(",").length>3){const s=t[n].match(/id=([^&]*)/);s&&(a=s[1]);const o=t[n].match(/port=([^&]*)/);o&&(l=o[1]);for(let s=1;s<r.length;s++){const o=r[s].split(",")[0];o&&(e+=`${o}:${l}${a?`#${a}`:""}\n`,t[n].includes("proxyip=true")&&proxyIPPool.push(`${o}:${l}`))}}else t[n].includes("proxyip=true")&&(proxyIPPool=proxyIPPool.concat((await 整理(s)).map((t=>{const e=t.split("#")[0]||t;if(!e.includes(":"))return`${e}:443`;{const t=e.split(":")[1];if(!httpsPorts.includes(t))return e}return null})).filter(Boolean))),e+=s+"\n"}}catch(t){console.error(t)}finally{clearTimeout(s)}return await 整理(e)}async function 整理测速结果(t){if(!addressescsv||0===addressescsv.length)return[];let e=[];for(const n of addressescsv)try{const s=await fetch(n);if(!s.ok){console.error("获取CSV地址时出错:",s.status,s.statusText);continue}const o=await s.text();let r;r=o.includes("\r\n")?o.split("\r\n"):o.split("\n");const a=r[0].split(",").indexOf("TLS"),l=0,i=1,c=a+remarkIndex;if(-1===a){console.error("CSV文件缺少必需的字段");continue}for(let s=1;s<r.length;s++){const o=r[s].split(","),d=o.length-1;if(o[a].toUpperCase()===t&&parseFloat(o[d])>DLS){const t=o[l],s=o[i],r=`${t}:${s}#${o[c]}`;e.push(r),n.includes("proxyip=true")&&"true"==o[a].toUpperCase()&&!httpsPorts.includes(s)&&proxyIPPool.push(`${t}:${s}`)}}}catch(t){console.error("获取CSV地址时出错:",t);continue}return e}function 生成本地订阅(t,e,n,s,o,r,a){const l=/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[.*\]):?(\d+)?#?(.*)?$/;let i;if(addresses=addresses.concat(s),addresses=addresses.concat(o),"true"==n){addressesnotls=addressesnotls.concat(r),addressesnotls=addressesnotls.concat(a);i=[...new Set(addressesnotls)].map((n=>{let s="-1",o=n;const r=o.match(l);if(r)n=r[1],s=r[2]||s,o=r[3]||n;else{if(n.includes(":")&&n.includes("#")){const t=n.split(":");n=t[0];const e=t[1].split("#");s=e[0],o=e[1]}else if(n.includes(":")){const t=n.split(":");n=t[0],s=t[1]}else if(n.includes("#")){const t=n.split("#");n=t[0],o=t[1]}o.includes(":")&&(o=o.split(":")[0])}const a=["8080","8880","2052","2082","2086","2095"];if(!isValidIPv4(n)&&"-1"==s)for(let t of a)if(n.includes(t)){s=t;break}"-1"==s&&(s="80");let i=t,c=path;return`${atob(啥啥啥_写的这是啥啊)}://${e}@${n}:${s+atob("P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT0mdHlwZT13cyZob3N0PQ==")+i}&path=${encodeURIComponent(c)}#${encodeURIComponent(o+"")}`})).join("\n")}const c=[...new Set(addresses)].map((n=>{let s="-1",o=n;const r=o.match(l);if(r)n=r[1],s=r[2]||s,o=r[3]||n;else{if(n.includes(":")&&n.includes("#")){const t=n.split(":");n=t[0];const e=t[1].split("#");s=e[0],o=e[1]}else if(n.includes(":")){const t=n.split(":");n=t[0],s=t[1]}else if(n.includes("#")){const t=n.split("#");n=t[0],o=t[1]}o.includes(":")&&(o=o.split(":")[0])}if(!isValidIPv4(n)&&"-1"==s)for(let t of httpsPorts)if(n.includes(t)){s=t;break}"-1"==s&&(s="443");let a=t,i=path,c="";const d=proxyIPPool.find((t=>t.includes(n)));d&&(i+=`&proxyip=${d}`),proxyhosts.length>0&&a.includes(".workers.dev")&&(i=`/${a}${i}`,a=proxyhosts[Math.floor(Math.random()*proxyhosts.length)],c=" 已启用临时域名中转服务，请尽快绑定自定义域！");return`${atob(啥啥啥_写的这是啥啊)}://${e}@${n}:${s+atob("P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT10bHMmc25pPQ==")+a}&fp=random&type=ws&host=${a}&path=${encodeURIComponent(i)}#${encodeURIComponent(o+c)}`})).join("\n");let d=c;return"true"==n&&(d+=`\n${i}`),link.length>0&&(d+="\n"+link.join("\n")),btoa(d)}async function 整理(t){var e=t.replace(/[	|"'\r\n]+/g,",").replace(/,+/g,",");","==e.charAt(0)&&(e=e.slice(1)),","==e.charAt(e.length-1)&&(e=e.slice(0,e.length-1));return e.split(",")}async function sendMessage(t,e,n=""){if(BotToken&&ChatID)try{let s="";const o=await fetch(`http://ip-api.com/json/${e}?lang=zh-CN`);if(o.ok){const r=await o.json();s=`${t}\nIP: ${e}\n国家: ${r.country}\n<tg-spoiler>城市: ${r.city}\n组织: ${r.org}\nASN: ${r.as}\n${n}`}else s=`${t}\nIP: ${e}\n<tg-spoiler>${n}`;const r=`https://api.telegram.org/bot${BotToken}/sendMessage?chat_id=${ChatID}&parse_mode=HTML&text=${encodeURIComponent(s)}`;return fetch(r,{method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","Accept-Encoding":"gzip, deflate, br","User-Agent":"Mozilla/5.0 Chrome/90.0.4430.72"}})}catch(t){console.error("Error sending message:",t)}}function isValidIPv4(t){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(t)}function 生成动态UUID(t){const e=new Date(2007,6,7,更新时间,0,0),n=864e5*有效时间;function 生成UUID(t){const e=(new TextEncoder).encode(t);return crypto.subtle.digest("SHA-256",e).then((t=>{const e=Array.from(new Uint8Array(t)).map((t=>t.toString(16).padStart(2,"0"))).join("");return`${e.substr(0,8)}-${e.substr(8,4)}-4${e.substr(13,3)}-${(63&parseInt(e.substr(16,2),16)|128).toString(16)}${e.substr(18,2)}-${e.substr(20,12)}`}))}const s=function(){const t=new Date,s=new Date(t.getTime()+288e5),o=Number(s)-Number(e);return Math.ceil(o/n)}(),o=new Date(e.getTime()+s*n),r=生成UUID(t+s),a=生成UUID(t+(s-1)),l=`到期时间(UTC): ${new Date(o.getTime()-288e5).toISOString().slice(0,19).replace("T"," ")} (UTC+8): ${o.toISOString().slice(0,19).replace("T"," ")}\n`;return Promise.all([r,a,l])}async function 迁移地址列表(t,e="ADD.txt"){const n=await t.KV.get(`/${e}`),s=await t.KV.get(e);return!(!n||s)&&(await t.KV.put(e,n),await t.KV.delete(`/${e}`),!0)}async function KV(t,e,n="ADD.txt"){try{if("POST"===t.method){if(!e.KV)return new Response("未绑定KV空间",{status:400});try{const s=await t.text();return await e.KV.put(n,s),new Response("保存成功")}catch(t){return console.error("保存KV时发生错误:",t),new Response("保存失败: "+t.message,{status:500})}}let s="",o=!!e.KV;if(o)try{s=await e.KV.get(n)||""}catch(t){console.error("读取KV时发生错误:",t),s="读取数据时发生错误: "+t.message}const r=`\n\t\t\t<!DOCTYPE html>\n\t\t\t<html>\n\t\t\t<head>\n\t\t\t\t<title>优选订阅列表</title>\n\t\t\t\t<meta charset="utf-8">\n\t\t\t\t<meta name="viewport" content="width=device-width, initial-scale=1">\n\t\t\t\t<style>\n\t\t\t\t\tbody {\n\t\t\t\t\t\tmargin: 0;\n\t\t\t\t\t\tpadding: 15px; /* 调整padding */\n\t\t\t\t\t\tbox-sizing: border-box;\n\t\t\t\t\t\tfont-size: 13px; /* 设置全局字体大小 */\n\t\t\t\t\t}\n\t\t\t\t\t.editor-container {\n\t\t\t\t\t\twidth: 100%;\n\t\t\t\t\t\tmax-width: 100%;\n\t\t\t\t\t\tmargin: 0 auto;\n\t\t\t\t\t}\n\t\t\t\t\t.editor {\n\t\t\t\t\t\twidth: 100%;\n\t\t\t\t\t\theight: 520px; /* 调整高度 */\n\t\t\t\t\t\tmargin: 15px 0; /* 调整margin */\n\t\t\t\t\t\tpadding: 10px; /* 调整padding */\n\t\t\t\t\t\tbox-sizing: border-box;\n\t\t\t\t\t\tborder: 1px solid #ccc;\n\t\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t\t\tfont-size: 13px;\n\t\t\t\t\t\tline-height: 1.5;\n\t\t\t\t\t\toverflow-y: auto;\n\t\t\t\t\t\tresize: none;\n\t\t\t\t\t}\n\t\t\t\t\t.save-container {\n\t\t\t\t\t\tmargin-top: 8px; /* 调整margin */\n\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\talign-items: center;\n\t\t\t\t\t\tgap: 10px; /* 调整gap */\n\t\t\t\t\t}\n\t\t\t\t\t.save-btn, .back-btn {\n\t\t\t\t\t\tpadding: 6px 15px; /* 调整padding */\n\t\t\t\t\t\tcolor: white;\n\t\t\t\t\t\tborder: none;\n\t\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t\t\tcursor: pointer;\n\t\t\t\t\t}\n\t\t\t\t\t.save-btn {\n\t\t\t\t\t\tbackground: #4CAF50;\n\t\t\t\t\t}\n\t\t\t\t\t.save-btn:hover {\n\t\t\t\t\t\tbackground: #45a049;\n\t\t\t\t\t}\n\t\t\t\t\t.back-btn {\n\t\t\t\t\t\tbackground: #666;\n\t\t\t\t\t}\n\t\t\t\t\t.back-btn:hover {\n\t\t\t\t\t\tbackground: #555;\n\t\t\t\t\t}\n\t\t\t\t\t.save-status {\n\t\t\t\t\t\tcolor: #666;\n\t\t\t\t\t}\n\t\t\t\t\t.notice-content {\n\t\t\t\t\t\tdisplay: none;\n\t\t\t\t\t\tmargin-top: 10px;\n\t\t\t\t\t\tfont-size: 13px;\n\t\t\t\t\t\tcolor: #333;\n\t\t\t\t\t}\n\t\t\t\t</style>\n\t\t\t</head>\n\t\t\t<body>\n\t\t\t\t################################################################<br>\n\t\t\t\t${FileName} 优选订阅列表:<br>\n\t\t\t\t---------------------------------------------------------------<br>\n\t\t\t\t&nbsp;&nbsp;<strong><a href="javascript:void(0);" id="noticeToggle" onclick="toggleNotice()">注意事项∨</a></strong><br>\n\t\t\t\t<div id="noticeContent" class="notice-content">\n\t\t\t\t\t${decodeURIComponent(atob("JTA5JTA5JTA5JTA5JTA5JTNDc3Ryb25nJTNFMS4lM0MlMkZzdHJvbmclM0UlMjBBRERBUEklMjAlRTUlQTYlODIlRTYlOUUlOUMlRTYlOTglQUYlRTUlOEYlOEQlRTQlQkIlQTNJUCVFRiVCQyU4QyVFNSU4RiVBRiVFNCVCRCU5QyVFNCVCOCVCQVBST1hZSVAlRTclOUElODQlRTglQUYlOUQlRUYlQkMlOEMlRTUlOEYlQUYlRTUlQjAlODYlMjIlM0Zwcm94eWlwJTNEdHJ1ZSUyMiVFNSU4RiU4MiVFNiU5NSVCMCVFNiVCNyVCQiVFNSU4QSVBMCVFNSU4OCVCMCVFOSU5MyVCRSVFNiU4RSVBNSVFNiU5QyVBQiVFNSVCMCVCRSVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZtYWluJTJGYWRkcmVzc2VzYXBpLnR4dCUzQ3N0cm9uZyUzRSUzRnByb3h5aXAlM0R0cnVlJTNDJTJGc3Ryb25nJTNFJTNDYnIlM0UlM0NiciUzRQolMDklMDklMDklMDklMDklM0NzdHJvbmclM0UyLiUzQyUyRnN0cm9uZyUzRSUyMEFEREFQSSUyMCVFNSVBNiU4MiVFNiU5RSU5QyVFNiU5OCVBRiUyMCUzQ2ElMjBocmVmJTNEJTI3aHR0cHMlM0ElMkYlMkZnaXRodWIuY29tJTJGWElVMiUyRkNsb3VkZmxhcmVTcGVlZFRlc3QlMjclM0VDbG91ZGZsYXJlU3BlZWRUZXN0JTNDJTJGYSUzRSUyMCVFNyU5QSU4NCUyMGNzdiUyMCVFNyVCQiU5MyVFNiU5RSU5QyVFNiU5NiU4NyVFNCVCQiVCNiVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZtYWluJTJGQ2xvdWRmbGFyZVNwZWVkVGVzdC5jc3YlM0NiciUzRSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCLSUyMCVFNSVBNiU4MiVFOSU5QyU4MCVFNiU4QyU4NyVFNSVBRSU5QTIwNTMlRTclQUIlQUYlRTUlOEYlQTMlRTUlOEYlQUYlRTUlQjAlODYlMjIlM0Zwb3J0JTNEMjA1MyUyMiVFNSU4RiU4MiVFNiU5NSVCMCVFNiVCNyVCQiVFNSU4QSVBMCVFNSU4OCVCMCVFOSU5MyVCRSVFNiU4RSVBNSVFNiU5QyVBQiVFNSVCMCVCRSVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZtYWluJTJGQ2xvdWRmbGFyZVNwZWVkVGVzdC5jc3YlM0NzdHJvbmclM0UlM0Zwb3J0JTNEMjA1MyUzQyUyRnN0cm9uZyUzRSUzQ2JyJTNFJTNDYnIlM0UKJTA5JTA5JTA5JTA5JTA5JTI2bmJzcCUzQiUyNm5ic3AlM0ItJTIwJUU1JUE2JTgyJUU5JTlDJTgwJUU2JThDJTg3JUU1JUFFJTlBJUU4JThBJTgyJUU3JTgyJUI5JUU1JUE0JTg3JUU2JUIzJUE4JUU1JThGJUFGJUU1JUIwJTg2JTIyJTNGaWQlM0RDRiVFNCVCQyU5OCVFOSU4MCU4OSUyMiVFNSU4RiU4MiVFNiU5NSVCMCVFNiVCNyVCQiVFNSU4QSVBMCVFNSU4OCVCMCVFOSU5MyVCRSVFNiU4RSVBNSVFNiU5QyVBQiVFNSVCMCVCRSVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZtYWluJTJGQ2xvdWRmbGFyZVNwZWVkVGVzdC5jc3YlM0NzdHJvbmclM0UlM0ZpZCUzRENGJUU0JUJDJTk4JUU5JTgwJTg5JTNDJTJGc3Ryb25nJTNFJTNDYnIlM0UlM0NiciUzRQolMDklMDklMDklMDklMDklMjZuYnNwJTNCJTI2bmJzcCUzQi0lMjAlRTUlQTYlODIlRTklOUMlODAlRTYlOEMlODclRTUlQUUlOUElRTUlQTQlOUElRTQlQjglQUElRTUlOEYlODIlRTYlOTUlQjAlRTUlODglOTklRTklOUMlODAlRTglQTYlODElRTQlQkQlQkYlRTclOTQlQTglMjclMjYlMjclRTUlODElOUElRTklOTclQjQlRTklOUElOTQlRUYlQkMlOEMlRTQlQkUlOEIlRTUlQTYlODIlRUYlQkMlOUElM0NiciUzRQolMDklMDklMDklMDklMDklMjZuYnNwJTNCJTI2bmJzcCUzQmh0dHBzJTNBJTJGJTJGcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSUyRmNtbGl1JTJGV29ya2VyVmxlc3Myc3ViJTJGbWFpbiUyRkNsb3VkZmxhcmVTcGVlZFRlc3QuY3N2JTNGaWQlM0RDRiVFNCVCQyU5OCVFOSU4MCU4OSUzQ3N0cm9uZyUzRSUyNiUzQyUyRnN0cm9uZyUzRXBvcnQlM0QyMDUzJTNDYnIlM0U="))}\n\t\t\t\t</div>\n\t\t\t\t<div class="editor-container">\n\t\t\t\t\t${o?`\n\t\t\t\t\t<textarea class="editor" \n\t\t\t\t\t\tplaceholder="${decodeURIComponent(atob("QUREJUU3JUE0JUJBJUU0JUJFJThCJUVGJUJDJTlBCnZpc2EuY24lMjMlRTQlQkMlOTglRTklODAlODklRTUlOUYlOUYlRTUlOTAlOEQKMTI3LjAuMC4xJTNBMTIzNCUyM0NGbmF0CiU1QjI2MDYlM0E0NzAwJTNBJTNBJTVEJTNBMjA1MyUyM0lQdjYKCiVFNiVCMyVBOCVFNiU4NCU4RiVFRiVCQyU5QQolRTYlQUYlOEYlRTglQTElOEMlRTQlQjglODAlRTQlQjglQUElRTUlOUMlQjAlRTUlOUQlODAlRUYlQkMlOEMlRTYlQTAlQkMlRTUlQkMlOEYlRTQlQjglQkElMjAlRTUlOUMlQjAlRTUlOUQlODAlM0ElRTclQUIlQUYlRTUlOEYlQTMlMjMlRTUlQTQlODclRTYlQjMlQTgKSVB2NiVFNSU5QyVCMCVFNSU5RCU4MCVFOSU5QyU4MCVFOCVBNiU4MSVFNyU5NCVBOCVFNCVCOCVBRCVFNiU4QiVBQyVFNSU4RiVCNyVFNiU4QiVBQyVFOCVCNSVCNyVFNiU5RCVBNSVFRiVCQyU4QyVFNSVBNiU4MiVFRiVCQyU5QSU1QjI2MDYlM0E0NzAwJTNBJTNBJTVEJTNBMjA1MwolRTclQUIlQUYlRTUlOEYlQTMlRTQlQjglOEQlRTUlODYlOTklRUYlQkMlOEMlRTklQkIlOTglRTglQUUlQTQlRTQlQjglQkElMjA0NDMlMjAlRTclQUIlQUYlRTUlOEYlQTMlRUYlQkMlOEMlRTUlQTYlODIlRUYlQkMlOUF2aXNhLmNuJTIzJUU0JUJDJTk4JUU5JTgwJTg5JUU1JTlGJTlGJUU1JTkwJThECgoKQUREQVBJJUU3JUE0JUJBJUU0JUJFJThCJUVGJUJDJTlBCmh0dHBzJTNBJTJGJTJGcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSUyRmNtbGl1JTJGV29ya2VyVmxlc3Myc3ViJTJGcmVmcyUyRmhlYWRzJTJGbWFpbiUyRmFkZHJlc3Nlc2FwaS50eHQKCiVFNiVCMyVBOCVFNiU4NCU4RiVFRiVCQyU5QUFEREFQSSVFNyU5QiVCNCVFNiU4RSVBNSVFNiVCNyVCQiVFNSU4QSVBMCVFNyU5QiVCNCVFOSU5MyVCRSVFNSU4RCVCMyVFNSU4RiVBRg=="))}"\n\t\t\t\t\t\tid="content">${s}</textarea>\n\t\t\t\t\t<div class="save-container">\n\t\t\t\t\t\t<button class="back-btn" onclick="goBack()">返回配置页</button>\n\t\t\t\t\t\t<button class="save-btn" onclick="saveContent(this)">保存</button>\n\t\t\t\t\t\t<span class="save-status" id="saveStatus"></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<br>\n\t\t\t\t\t################################################################<br>\n\t\t\t\t\t${cmad}\n\t\t\t\t\t`:"<p>未绑定KV空间</p>"}\n\t\t\t\t</div>\n\t\t\n\t\t\t\t<script>\n\t\t\t\tif (document.querySelector('.editor')) {\n\t\t\t\t\tlet timer;\n\t\t\t\t\tconst textarea = document.getElementById('content');\n\t\t\t\t\tconst originalContent = textarea.value;\n\t\t\n\t\t\t\t\tfunction goBack() {\n\t\t\t\t\t\tconst currentUrl = window.location.href;\n\t\t\t\t\t\tconst parentUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/'));\n\t\t\t\t\t\twindow.location.href = parentUrl;\n\t\t\t\t\t}\n\t\t\n\t\t\t\t\tfunction replaceFullwidthColon() {\n\t\t\t\t\t\tconst text = textarea.value;\n\t\t\t\t\t\ttextarea.value = text.replace(/：/g, ':');\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tfunction saveContent(button) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst updateButtonText = (step) => {\n\t\t\t\t\t\t\t\tbutton.textContent = \`保存中: \${step}\`;\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t// 检测是否为iOS设备\n\t\t\t\t\t\t\tconst isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t// 仅在非iOS设备上执行replaceFullwidthColon\n\t\t\t\t\t\t\tif (!isIOS) {\n\t\t\t\t\t\t\t\treplaceFullwidthColon();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tupdateButtonText('开始保存');\n\t\t\t\t\t\t\tbutton.disabled = true;\n\t\t\t\t\t\t\t// 获取textarea内容和原始内容\n\t\t\t\t\t\t\tconst textarea = document.getElementById('content');\n\t\t\t\t\t\t\tif (!textarea) {\n\t\t\t\t\t\t\t\tthrow new Error('找不到文本编辑区域');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tupdateButtonText('获取内容');\n\t\t\t\t\t\t\tlet newContent;\n\t\t\t\t\t\t\tlet originalContent;\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tnewContent = textarea.value || '';\n\t\t\t\t\t\t\t\toriginalContent = textarea.defaultValue || '';\n\t\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t\tconsole.error('获取内容错误:', e);\n\t\t\t\t\t\t\t\tthrow new Error('无法获取编辑内容');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tupdateButtonText('准备状态更新函数');\n\t\t\t\t\t\t\tconst updateStatus = (message, isError = false) => {\n\t\t\t\t\t\t\t\tconst statusElem = document.getElementById('saveStatus');\n\t\t\t\t\t\t\t\tif (statusElem) {\n\t\t\t\t\t\t\t\t\tstatusElem.textContent = message;\n\t\t\t\t\t\t\t\t\tstatusElem.style.color = isError ? 'red' : '#666';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tupdateButtonText('准备按钮重置函数');\n\t\t\t\t\t\t\tconst resetButton = () => {\n\t\t\t\t\t\t\t\tbutton.textContent = '保存';\n\t\t\t\t\t\t\t\tbutton.disabled = false;\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tif (newContent !== originalContent) {\n\t\t\t\t\t\t\t\tupdateButtonText('发送保存请求');\n\t\t\t\t\t\t\t\tfetch(window.location.href, {\n\t\t\t\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\t\t\t\tbody: newContent,\n\t\t\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\t\t'Content-Type': 'text/plain;charset=UTF-8'\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tcache: 'no-cache'\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(response => {\n\t\t\t\t\t\t\t\t\tupdateButtonText('检查响应状态');\n\t\t\t\t\t\t\t\t\tif (!response.ok) {\n\t\t\t\t\t\t\t\t\t\tthrow new Error(\`HTTP error! status: \${response.status}\`);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tupdateButtonText('更新保存状态');\n\t\t\t\t\t\t\t\t\tconst now = new Date().toLocaleString();\n\t\t\t\t\t\t\t\t\tdocument.title = \`编辑已保存 \${now}\`;\n\t\t\t\t\t\t\t\t\tupdateStatus(\`已保存 \${now}\`);\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.catch(error => {\n\t\t\t\t\t\t\t\t\tupdateButtonText('处理错误');\n\t\t\t\t\t\t\t\t\tconsole.error('Save error:', error);\n\t\t\t\t\t\t\t\t\tupdateStatus(\`保存失败: \${error.message}\`, true);\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.finally(() => {\n\t\t\t\t\t\t\t\t\tresetButton();\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tupdateButtonText('检查内容变化');\n\t\t\t\t\t\t\t\tupdateStatus('内容未变化');\n\t\t\t\t\t\t\t\tresetButton();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tconsole.error('保存过程出错:', error);\n\t\t\t\t\t\t\tbutton.textContent = '保存';\n\t\t\t\t\t\t\tbutton.disabled = false;\n\t\t\t\t\t\t\tconst statusElem = document.getElementById('saveStatus');\n\t\t\t\t\t\t\tif (statusElem) {\n\t\t\t\t\t\t\t\tstatusElem.textContent = \`错误: \${error.message}\`;\n\t\t\t\t\t\t\t\tstatusElem.style.color = 'red';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\n\t\t\t\t\ttextarea.addEventListener('blur', saveContent);\n\t\t\t\t\ttextarea.addEventListener('input', () => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t\ttimer = setTimeout(saveContent, 5000);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\n\t\t\t\tfunction toggleNotice() {\n\t\t\t\t\tconst noticeContent = document.getElementById('noticeContent');\n\t\t\t\t\tconst noticeToggle = document.getElementById('noticeToggle');\n\t\t\t\t\tif (noticeContent.style.display === 'none' || noticeContent.style.display === '') {\n\t\t\t\t\t\tnoticeContent.style.display = 'block';\n\t\t\t\t\t\tnoticeToggle.textContent = '注意事项∧';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnoticeContent.style.display = 'none';\n\t\t\t\t\t\tnoticeToggle.textContent = '注意事项∨';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\n\t\t\t\t// 初始化 noticeContent 的 display 属性\n\t\t\t\tdocument.addEventListener('DOMContentLoaded', () => {\n\t\t\t\t\tdocument.getElementById('noticeContent').style.display = 'none';\n\t\t\t\t});\n\t\t\t\t<\/script>\n\t\t\t</body>\n\t\t\t</html>\n\t\t`;return new Response(r,{headers:{"Content-Type":"text/html;charset=utf-8"}})}catch(t){return console.error("处理请求时发生错误:",t),new Response("服务器错误: "+t.message,{status:500,headers:{"Content-Type":"text/plain;charset=utf-8"}})}}
